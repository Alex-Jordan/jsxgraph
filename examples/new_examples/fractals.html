<!DOCTYPE html>
<html>
<head>
    <title>JSXGraph example</title>

    <!-- JSXGraph -->
    <link rel="stylesheet" type="text/css" href="../../distrib/jsxgraph.css" />
    <link rel="stylesheet" type="text/css" href="css/dark.css" />
    <script type="text/javascript" src="../../src/loadjsxgraph.js"></script>

    <!-- jQuery -->
    <script type="text/javascript" src="../../distrib/jquery.min.js"></script>

    <!-- Syntax Highlighting -->
    <link rel="stylesheet" type="text/css" href="css/shCore.css" />
    <link rel="stylesheet" type="text/css" href="css/shThemeDark.css" />
    <script type="text/javascript" src="js/shCore.js"></script>
    <script type="text/javascript" src="js/shBrushJScript.js"></script>
</head>

<body>

<img src="img/logo-darker.png" id="watermark" />

<div id="header">
    <!--powered by<br /-->
    <span id="jsxgraph-head"><a href="http://jsxgraph.org/"><img src="img/logo-grayscale.png" alt="JSXGraph" /></a></span>
</div>

<div id="title">
    <ul id="menu">
        <li id="menu-title"><h2><a href="javascript:void(0);" id="head-construction">Fractals</a></h2></li>
        <li id="menu-info"><h2><a href="javascript:void(0);" id="head-explanation">Info</a></h2></li>
        <li id="menu-source"><h2><a href="javascript:void(0);" id="head-source">Source</a></h2></li>
    </ul>
</div>

<div id="container" class="content-block">
    <center>
    <div id="construction">
        <div id="control" style="width: 300px; height: 300px; float: left; text-align: left;">
            <div id="controlroom" class="jxgbox" style="width: 300px; height: 300px; float: left;"></div>
            <button id="add">Add</button>
            <button id="rm">Remove</button>
            <button id="draw">Draw</button>
            <br />
            <h4>Examples</h4>
            <ul id="examples" class="list-2c">
            </ul>
        </div>
        <div id="jxgbox" class="jxgbox" style="width: 550px; height: 550px;"></div>
    </div>
    </center>

<script type="text/javascript" src="js/jsxgraph-dark.js">
</script>

<script id="jxg" type="text/javascript">

    (function() {
        var i,

            // control room
            control,// = JXG.JSXGraph.initBoard('controlroom', {boundingbox: [-7, 7, 7, -7], axis: false, grid: false}),
            cpoint = {
                withLabel: false
            },
            cp = [],

            colors = [JXG.Options.line.strokeColor, JXG.Options.curve.strokeColor, 'yellow'],
            cs = [],
            states = [0],

            // fractal view
            board = JXG.JSXGraph.initBoard('jxgbox', {boundingbox: [-275, 275, 275, -275], axis: false, grid: false, showNavigation: true}),
            t = board.create('turtle'),

            draw = function (lvl) {
                var lengths = [], tlength, angles = [], fun;

                // reset turtle
                t.cs();
                t.hideTurtle();
                t.setPos(-250,0);
                t.rt(90);

                board.zoom100();
                board.setBoundingBox([-275, 275, 275, -275]);

                // calculate each segments length and the angles
                angles.push((cs[0].getAngle() - cs[cs.length-1].getAngle())*57.295779513082323);

                for (i = 0; i < cp.length - 1; i++) {
                    lengths.push(cp[i].Dist(cp[i+1]));

                    if (i !== cp.length - 2) {
                        angles.push(JXG.Math.Geometry.trueAngle(cp[i], cp[i+1], cp[i+2]) - 180);
                    }
                }
                
                tlength = cp[0].Dist(cp[cp.length-1]);
                angles.push((2*Math.PI - cs[cs.length-2].getAngle() + cs[cs.length-1].getAngle())*57.295779513082323);

                // compile control room configuration
                fun = function (x, lvl) {
                    var i;

                    if (lvl < 1) {
                        t.fd(x);
                    } else {
                        for (i = 0; i < cp.length - 1; i++) {
                            t.lt(angles[i]);

                            if (cs[i].state === 0) {
                                fun(lengths[i]/tlength*x, lvl-1);
                            } else {
                                if (cs[i].state === 2) {
                                    t.pu();
                                }
                                t.fd(lengths[i]/tlength*x);
                                t.pd();
                            }
                        }
                        t.lt(angles[angles.length-1]);
                    }
                };

                fun(500, lvl);
            },

            examples = {
                "Straight Line": {
                    points: [[-6, 0], [-2, 0], [2, 0], [6, 0]],
                    states: [0]
                },
                "Koch Curve": {
                    points: [[-6, 0], [-2, 0], [0, Math.sqrt(12)], [2, 0], [6, 0]],
                    states: [0]
                },
                Fern: {
                    points: [[0, -6], [0, -3], [1, 5], [0, -4], [-3, 0], [0, -5], [2, 0.5], [0, 6]],
                    states: [1, 0, 2, 0, 2, 0, 0]
                },
                Something: {
                    points: [[-6, 0], [-3, 2], [0, 0], [3, 2], [6, 0]],
                    states: [0]
                },
                "Sierpinski Triangle": {
                    points: [[-6, 0], [0, 0], [-3, 4.5], [3, 4.5], [0, 0], [6, 0]],
                    states: [0, 2, 0, 2, 0]
                }
            },

            reinit_controls = function (what, nodelete) {
                var example = examples[what],
                    states = example.states;

                if (!nodelete) {
                    JXG.JSXGraph.freeBoard(control);
                }

                control = JXG.JSXGraph.initBoard('controlroom', {boundingbox: [-7, 7, 7, -7], axis: false, grid: false});
                control.options.grid.snapToGrid = true;

                cp = [];
                for (i = 0; i < example.points.length; i++) {
                    cp.push(control.create('point', example.points[i], cpoint));
                }

                cs = [];
                for (i = 0; i < cp.length - 1; i++) {
                    cs.push(control.create('segment', [cp[i], cp[i+1]], {strokeColor: colors[states[i % states.length]]}));
                    cs[i].state = states[i % states.length];
                }
                cs.push(control.create('segment', [cp[0], cp[cp.length-1]], {visible: false}));
                //cs[cs.length - 1].state = states[(cs.length - 1) % states.length];

            };

        reinit_controls("Straight Line", true);

        // initialize turtle
        t.cs();
        t.hideTurtle();
        t.setPos(-250, cp[0].coords.usrCoords[1]/6*500);
        t.rt(90);
        t.setPenColor('white');

        // initialize ui
        for (i in examples) {
            $('#examples').append('<li><button id="example__'+ i.replace(/\s+/g, '_') +'__">'+i+'</button></li>');
            $('#example__' + i.replace(/\s+/g, '_') + '__').click((function (_i) {
                return function () {
                    reinit_controls(_i);
                }
            })(i));
        }

        control.addHook(function (e) {
            var cPos = this.getRelativeMouseCoordinates(e),
                absPos = JXG.getPosition(e),
                dx = absPos[0] - cPos[0],
                dy = absPos[1] - cPos[1],
                i;

            for (i = 0; i < cp.length; i++) {
                if (cp[i].hasPoint(dx, dy)) {
                    return;
                }
            }

            for (i = 0; i < cs.length; i++) {
                if (cs[i].hasPoint(dx, dy)) {
                    cs[i].state = (cs[i].state + 1) % 3;
                    cs[i].setProperty({strokeColor: colors[cs[i].state]});
                    console.log(cs[i], cs[i].state);
                    break;
                }
            }
        }, 'mousedown');

        $('#draw').click(function () {
            board.suspendUpdate();
            draw(13 - cp.length);
            board.unsuspendUpdate();
        });

        $('#add').click(function () {
            if (cp.length > 9) {
                return;
            }
            
            cp.push(control.create('point', [Math.random()*12-6, Math.random()*12-6], cpoint));
            cs[cs.length-1] = control.create('segment', [cp[cp.length-2], cp[cp.length-1]], {strokeColor: colors[0]});
            cs[cs.length-1].state = 0;
            cs.push(control.create('segment', [cp[0], cp[cp.length-1]], {visible: false}));
        });
        $('#rm').click(function () {
            if (cp.length < 3) {
                return;
            }
            
            board.removeObject(cp.pop());
            board.removeObject(cs.pop());
            board.removeObject(cs.pop());
            cs.push(control.create('segment', [cp[0], cp[cp.length-1]], {visible: false}));
        });
    })();
</script>
</div>

<div id="explanation" class="content-block">
    Fractals
</div>


<div id="source" class="content-block">
    <script id="jxgsource" type="syntaxhighlighter" class="brush: js"></script>
</div>

<div id="footer">
    JSXGraph is licensed under <a href="http://www.gnu.org/licenses/lgpl.txt">LGPL</a>; &copy; 2008-2011 <a href="http://jsxgraph.uni-bayreuth.de/wp/documentation/the-team/">JSXGraph Team</a>
</div>


<script type="text/javascript">
    // <![CDATA[

    $(document).ready(function() {
        var parts = {
                construction: 'show',
                source: 'hide',
                explanation: 'hide'
            },
            part;

        $('#jxgsource').text($('#jxg').text());
        SyntaxHighlighter.all();

        for(part in parts) {
            $('#' + part)[parts[part]]();

            $('#head-'+part).click(function(_part) {
                return function() {
                    var p;
                    for(p in parts) {
                        $('#' + p).hide();
                    }

                    $('#'+_part).show();
                }
            }(part));
        }
    });

    // ]]>
</script>
</body>
</html>
